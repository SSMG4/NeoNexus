# Windows CI for NeoNexus (x64 only)
name: Windows CI

on:
  workflow_dispatch:
    inputs:
      configuration:
        description: 'Configuration to build'
        required: true
        default: 'Release'
      publish:
        description: 'Publish managed app after build (true/false)'
        required: true
        default: 'true'

jobs:
  build:
    name: Build (Windows x64)
    runs-on: windows-latest
    env:
      DOTNET_NOLOGO: 'true'
      PublishConfig: ${{ github.event.inputs.configuration || 'Release' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Setup .NET 8
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '8.0.x'

      - name: Setup MSBuild Tools (Visual Studio)
        uses: microsoft/setup-msbuild@v1

      - name: Ensure CMake available (install only if missing)
        run: |
          $cm = Get-Command cmake -ErrorAction SilentlyContinue
          if ($cm) {
            Write-Host "CMake found at $($cm.Source)"
            cmake --version
          } else {
            Write-Host "CMake not found. Installing via Chocolatey..."
            choco install cmake -y
            cmake --version
          }
        shell: powershell

      - name: Ensure WiX available (install only if missing)
        run: |
          $candle = Get-Command candle.exe -ErrorAction SilentlyContinue
          if ($candle) {
            Write-Host "WiX detected: $($candle.Source)"
          } else {
            Write-Host "WiX not found; installing via Chocolatey..."
            choco install wix -y
          }
        shell: powershell

      - name: Restore NuGet packages
        run: dotnet restore Windows/win/NeoNexus.WinDemo/NeoNexus.WinDemo.csproj
        shell: powershell

      - name: Build native (CMake x64 ${{ env.PublishConfig }})
        working-directory: Windows/native
        run: |
          mkdir -Force build
          cmake -S . -B build -G "Visual Studio 17 2022" -A x64
          cmake --build build --config $env:PublishConfig
        shell: powershell

      - name: Build managed (dotnet build)
        run: dotnet build Windows/win/NeoNexus.WinDemo/NeoNexus.WinDemo.csproj -c ${{ env.PublishConfig }}
        shell: powershell

      - name: Run unit tests
        run: dotnet test Windows/tests/managed_tests/NeoNexus.WinDemo.Tests/NeoNexus.WinDemo.Tests.csproj -c ${{ env.PublishConfig }} --no-build --verbosity normal
        shell: powershell

      - name: Publish managed app (win-x64)
        if: ${{ contains(toLower(github.event.inputs.publish || 'true'), 'true') }}
        run: |
          $cfg = "${{ env.PublishConfig }}"
          $out = "Windows/win/NeoNexus.WinDemo/bin/$cfg/net8.0-windows/win-x64/publish"
          dotnet publish Windows/win/NeoNexus.WinDemo/NeoNexus.WinDemo.csproj -c $cfg -r win-x64 -o $out --self-contained false
          Write-Host "Published to $out"
        shell: powershell

      - name: Zip publish folder for debugging & upload
        if: ${{ contains(toLower(github.event.inputs.publish || 'true'), 'true') }}
        run: |
          $cfg = "${{ env.PublishConfig }}"
          $publish = "Windows/win/NeoNexus.WinDemo/bin/$cfg/net8.0-windows/win-x64/publish"
          $artifact = "Windows/build/artifacts/NeoNexus-publish.zip"
          if (Test-Path $publish) {
            if (Test-Path $artifact) { Remove-Item $artifact -Force }
            Compress-Archive -Path "$publish\*" -DestinationPath $artifact
            Write-Host "Created artifact zip: $artifact"
          } else {
            Write-Host "Publish folder not found at $publish"
          }
        shell: powershell

      - name: Copy native DLL into publish folder
        run: |
          $cfg = "${{ env.PublishConfig }}"
          $native = "Windows/native/build/bin/NeoNexusNative.dll"
          $publish = "Windows/win/NeoNexus.WinDemo/bin/$cfg/net8.0-windows/win-x64/publish"
          if (Test-Path $native) {
            if (-not (Test-Path $publish)) { New-Item -ItemType Directory -Path $publish -Force | Out-Null }
            Copy-Item $native $publish -Force
            Write-Host "Copied native DLL to publish"
          } else {
            Write-Host "Native DLL not found at $native"
          }
        shell: powershell

      - name: Attempt Create MSI with WiX (harvest publish folder with heat.exe)
        run: |
          $wixDir = "Windows/installer/wix"
          $cfg = "${{ env.PublishConfig }}"
          $publish = Resolve-Path "Windows/win/NeoNexus.WinDemo/bin/$cfg/net8.0-windows/win-x64/publish" -ErrorAction SilentlyContinue
          if (-not $publish) {
            Write-Host "Publish folder not found. Ensure publish step ran (set publish=true). Aborting MSI creation."
            exit 0
          }
          $publishPath = $publish.Path
          Write-Host "Publish folder: $publishPath"

          Push-Location $wixDir

          # Harvest publish folder into a fragment file (PublishFiles.wxs) using heat.exe
          & heat.exe dir "$publishPath" -cg PublishFiles -gg -sfrag -srd -dr INSTALLFOLDER -var var.PublishDir -out PublishFiles.wxs
          if ($LASTEXITCODE -ne 0) { Write-Error "heat.exe failed"; Pop-Location; exit 1 }

          # Compile Product.wxs and harvest fragment
          & candle.exe -arch x64 -dPublishDir="$publishPath" Product.wxs PublishFiles.wxs
          if ($LASTEXITCODE -ne 0) { Write-Error "candle.exe failed"; Pop-Location; exit 1 }

          # Link with light, specify base (-b) so files are embedded from publish path
          & light.exe -ext WixUIExtension -b "$publishPath" Product.wixobj PublishFiles.wixobj -out ../../build/artifacts/NeoNexus.msi
          if ($LASTEXITCODE -ne 0) { Write-Error "light.exe failed"; Pop-Location; exit 1 }

          # Sanity-check MSI size; fail if suspiciously small (< 1 MB)
          $msi = Resolve-Path ../../build/artifacts/NeoNexus.msi -ErrorAction SilentlyContinue
          if (-not $msi) { Write-Error "MSI not found after light"; Pop-Location; exit 1 }
          if ((Get-Item $msi.Path).Length -lt 1MB) { Write-Error "MSI is unexpectedly small (<1MB). Failing build."; Pop-Location; exit 1 }

          Write-Host "MSI created at Windows/build/artifacts/NeoNexus.msi (size: $((Get-Item $msi.Path).Length) bytes)"

          Pop-Location
        shell: powershell

      - name: Upload publish folder zip
        uses: actions/upload-artifact@v4
        with:
          name: NeoNexus-publish-zip
          path: Windows/build/artifacts/NeoNexus-publish.zip
          if-no-files-found: ignore

      - name: Upload publish folder raw (optional)
        uses: actions/upload-artifact@v4
        with:
          name: NeoNexus-publish-folder
          path: Windows/win/NeoNexus.WinDemo/bin/${{ env.PublishConfig }}/net8.0-windows/win-x64/publish
          if-no-files-found: ignore

      - name: Upload PublishFiles.wxs / wixobj for debug
        uses: actions/upload-artifact@v4
        with:
          name: neo-wix-debug
          path: |
            Windows/installer/wix/PublishFiles.wxs
            Windows/installer/wix/PublishFiles.wixobj
            Windows/installer/wix/Product.wixobj
          if-no-files-found: ignore

      - name: Upload MSI (if exists)
        uses: actions/upload-artifact@v4
        with:
          name: NeoNexus-msi
          path: Windows/build/artifacts/NeoNexus.msi
          if-no-files-found: ignore

      - name: Upload native DLL (artifact)
        uses: actions/upload-artifact@v4
        with:
          name: NeoNexusNative.dll
          path: Windows/native/build/bin/NeoNexusNative.dll
          if-no-files-found: ignore
