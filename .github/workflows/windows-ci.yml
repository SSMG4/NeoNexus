# Windows CI for NeoNexus (x64 only)
name: Windows CI

on:
  workflow_dispatch:
    inputs:
      configuration:
        description: 'Configuration to build'
        required: true
        default: 'Release'
      publish:
        description: 'Publish managed app after build (true/false)'
        required: true
        default: 'true'

jobs:
  build:
    name: Build (Windows x64)
    runs-on: windows-latest
    env:
      DOTNET_NOLOGO: 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Setup .NET 8
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '8.0.x'

      - name: Setup MSBuild Tools (Visual Studio)
        uses: microsoft/setup-msbuild@v1

      - name: Ensure CMake available (install only if missing)
        run: |
          $cm = Get-Command cmake -ErrorAction SilentlyContinue
          if ($cm) {
            Write-Host "CMake found at $($cm.Source)"
            cmake --version
          } else {
            Write-Host "CMake not found. Installing via Chocolatey..."
            choco install cmake -y
            Write-Host "CMake installation exit code: $LASTEXITCODE"
            cmake --version
          }
        shell: powershell

      - name: Ensure WiX available (install only if missing)
        run: |
          $candle = Get-Command candle.exe -ErrorAction SilentlyContinue
          if ($candle) {
            Write-Host "WiX detected: $($candle.Source)"
          } else {
            Write-Host "WiX not found; installing via Chocolatey..."
            choco install wix -y
            Write-Host "WiX install exit code: $LASTEXITCODE"
          }
        shell: powershell

      - name: Restore NuGet packages
        run: dotnet restore Windows/win/NeoNexus.WinDemo/NeoNexus.WinDemo.csproj
        shell: powershell

      - name: Build native (CMake x64 Release)
        working-directory: Windows/native
        run: |
          mkdir -Force build
          cmake -S . -B build -G "Visual Studio 17 2022" -A x64
          cmake --build build --config Release
        shell: powershell

      - name: Build managed (dotnet build)
        run: dotnet build Windows/win/NeoNexus.WinDemo/NeoNexus.WinDemo.csproj -c ${{ github.event.inputs.configuration || 'Release' }}
        shell: powershell

      - name: Run unit tests
        run: dotnet test Windows/tests/managed_tests/NeoNexus.WinDemo.Tests/NeoNexus.WinDemo.Tests.csproj -c ${{ github.event.inputs.configuration || 'Release' }} --no-build --verbosity normal
        shell: powershell

      - name: Publish managed app (win-x64)
        if: ${{ github.event.inputs.publish == 'true' }}
        run: |
          dotnet publish Windows/win/NeoNexus.WinDemo/NeoNexus.WinDemo.csproj -c ${{ github.event.inputs.configuration || 'Release' }} -r win-x64 -o Windows/win/NeoNexus.WinDemo/bin/Release/net8.0-windows/win-x64/publish --self-contained false
        shell: powershell

      - name: Copy native DLL into publish folder
        run: |
          $native = "Windows/native/build/bin/NeoNexusNative.dll"
          $publish = "Windows/win/NeoNexus.WinDemo/bin/Release/net8.0-windows/win-x64/publish"
          if (Test-Path $native) {
            if (-not (Test-Path $publish)) { Write-Host "Publish folder not found; creating $publish"; New-Item -ItemType Directory -Path $publish -Force | Out-Null }
            Copy-Item $native $publish -Force
            Write-Host "Copied native DLL to publish"
          } else {
            Write-Host "Native DLL not found at $native"
          }
        shell: powershell

      - name: Attempt Create MSI with WiX (harvest publish folder with heat.exe)
        run: |
          $wixDir = "Windows/installer/wix"
          $publish = Resolve-Path "Windows/win/NeoNexus.WinDemo/bin/Release/net8.0-windows/win-x64/publish" -ErrorAction SilentlyContinue
          if (-not $publish) {
            Write-Host "Publish folder not found. Ensure publish step ran (set publish=true). Aborting MSI creation."
            exit 0
          }
          $publishPath = $publish.Path
          Write-Host "Publish folder: $publishPath"

          Push-Location $wixDir

          # Harvest publish folder into a fragment file (PublishFiles.wxs) using heat.exe
          # -gg: generate GUIDs for components
          # -srd: suppress root directory element (we will ref INSTALLFOLDER in Product.wxs)
          # -dr INSTALLFOLDER: set directory reference id
          # -var var.PublishDir: generate variables instead of absolute paths
          $heatCmd = "heat.exe dir `"$publishPath`" -cg PublishFiles -gg -sfrag -srd -dr INSTALLFOLDER -var var.PublishDir -out PublishFiles.wxs"
          Write-Host "Running: $heatCmd"
          & heat.exe dir "$publishPath" -cg PublishFiles -gg -sfrag -srd -dr INSTALLFOLDER -var var.PublishDir -out PublishFiles.wxs

          if ($LASTEXITCODE -ne 0) {
            Write-Host "heat.exe failed with exit code $LASTEXITCODE"
            Pop-Location
            exit 1
          }

          # Now call candle on both Product.wxs and PublishFiles.wxs; pass PublishDir variable for relative paths
          $candleCmd = "candle.exe -arch x64 -dPublishDir=`"$publishPath`" Product.wxs PublishFiles.wxs"
          Write-Host "Running: $candleCmd"
          & candle.exe -arch x64 -dPublishDir="$publishPath" Product.wxs PublishFiles.wxs
          if ($LASTEXITCODE -ne 0) {
            Write-Host "candle.exe failed with exit code $LASTEXITCODE"
            Pop-Location
            exit 1
          }

          # Link with light (include both wixobj files)
          $lightCmd = "light.exe -ext WixUIExtension Product.wixobj PublishFiles.wixobj -out ../../build/artifacts/NeoNexus.msi"
          Write-Host "Running: $lightCmd"
          & light.exe -ext WixUIExtension Product.wixobj PublishFiles.wixobj -out ../../build/artifacts/NeoNexus.msi
          if ($LASTEXITCODE -ne 0) {
            Write-Host "light.exe failed with exit code $LASTEXITCODE"
            Pop-Location
            exit 1
          }

          Write-Host "MSI created at Windows/build/artifacts/NeoNexus.msi"
          Pop-Location
        shell: powershell

      - name: Upload publish folder
        uses: actions/upload-artifact@v4
        with:
          name: NeoNexus-publish-win-x64
          path: Windows/win/NeoNexus.WinDemo/bin/Release/net8.0-windows/win-x64/publish

      - name: Upload MSI (if exists)
        uses: actions/upload-artifact@v4
        with:
          name: NeoNexus-msi
          path: Windows/build/artifacts/NeoNexus.msi
          if-no-files-found: ignore

      - name: Upload native DLL (artifact)
        uses: actions/upload-artifact@v4
        with:
          name: NeoNexusNative.dll
          path: Windows/native/build/bin/NeoNexusNative.dll
          if-no-files-found: ignore
